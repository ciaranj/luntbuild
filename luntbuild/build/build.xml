<project name="luntbuild" default="package" basedir="..">
<!--
	Define a default value for publishDir property, this property will be
	overrided to a publishing directory when build through luntbuild. All
	useful build artifacts should be put into directory defined by this property,
	or sub directories under it.
-->
	<property name="publishDir" location="${basedir}/distribute"/>
	<property name="compile-with-debug" value="on"/>

	<patternset id="web.resources">
		<include name="**/*.htm"/>
		<include name="**/*.html"/>
		<include name="**/*.page"/>
		<include name="**/*.jwc"/>
		<include name="**/*.xml"/>
		<include name="**/*.properties"/>
		<include name="**/*.gif"/>
		<include name="**/*.jpg"/>
		<include name="**/*.css"/>
		<include name="**/*.library"/>
		<include name="**/*.application"/>
	</patternset>

	<target name="prepare">
		<copy todir="webstage">
			<fileset dir="web">
				<patternset refid="web.resources"/>
			</fileset>
		</copy>
		<copy todir="webstage/WEB-INF/lib">
			<fileset dir="lib">
				<exclude name="servlet-api.*"/>
 			</fileset>
		</copy>
		<mkdir dir="webstage/WEB-INF/classes"/>
	</target>

	<target name="compile" depends="prepare">
		<javac srcdir="src" destdir="webstage/WEB-INF/classes" debug="${compile-with-debug}" >
			<classpath id="classpath">
				<fileset dir="lib" includes="**/*.jar"/>
			</classpath>
		</javac>
		<copy todir="webstage/WEB-INF/classes">
			<fileset dir="src">
				<patternset refid="web.resources"/>
			</fileset>
		</copy>
	</target>

	<target name="war" depends="compile">
		<delete file="webstage/WEB-INF/web.xml"/>
		<mkdir dir="stage/web"/>
		<war basedir="webstage" destfile="stage/web/luntbuild.war" webxml="web/WEB-INF/web.xml"/>
	</target>

	<target name="copyBuildInfo" if="buildInfoAvailable">
<!--
		Copy the property file about build information into the desired directory. This property
		file will be used by the application to show the build number and build date, etc.
-->
		<copy file="build/buildInfo.properties" todir="stage"/>
	</target>

	<target name="package" depends="war">
		<available file="build/buildInfo.properties" property="buildInfoAvailable"/>
		<antcall target="copyBuildInfo"/>
		<copy todir="stage">
			<fileset dir="." includes="*.txt"/>
		</copy>
		<copy todir="stage/osdependent">
			<fileset dir="osdependent"/>
		</copy>
		<copy todir="stage/db">
			<fileset dir="db"/>
		</copy>
		<mkdir dir="stage/work"/>
		<mkdir dir="stage/publish"/>
		<mkdir dir="stage/logs"/>
		<copy todir="stage/ant">
			<fileset dir="ant"/>
		</copy>
<!--
		Build artifacts should be putted into the ${publishDir} directory or its sub-directory
-->
		<mkdir dir="${publishDir}"/>
		<zip basedir="stage" destfile="${publishDir}/luntbuild.zip"/>
	</target>

	<target name="clean">
		<delete dir="webstage"/>
		<delete dir="stage"/>
		<delete file="${publishDir}/luntbuild.zip"/>
	</target>

</project>